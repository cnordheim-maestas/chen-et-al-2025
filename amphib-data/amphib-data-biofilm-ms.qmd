---
title: "Amphibian data for biofilm MS"
author: "Caitlin Nordheim-Maestas"
format: docx
---

Goal: Make table of amphibian abundance, Bd prevalence per site per species for supplementary materials & calculate xx % of sites had frogs at the time, and the fraction of frogs we detected Bd on for the main paper

# Load libraries & data

```{r}
#| warning: false
#| message: false

library(tidyverse) # for cleaning and viewing data
library(gt) # pretty stats tables
library(broom) # cleaning for gt function
library(here) # for importing data
library(lubridate) # for date cleaning and use

# import wrangled data
swab_may22 <- read.csv(here("amphib-data", "swab_may2022_ninesites.csv"))
swab_ncos <- read.csv(here("amphib-data", "ncos_data.csv"))
ves_may <- read.csv(here("amphib-data", "ves_may22.csv"))
```

# Data wrangling

## swab data

```{r}
# SFEB data collected in May 2022
eb_summary <- swab_may22 %>% 
  group_by(code, amphibian_spp, date) %>% # group by site (aka code) and species
  summarise(
    n_frogs = n(), # total frogs swabbed in that site and spp
    bd_positive = sum(infected == 1), # number of bd+ frogs
    prevalence = round(100 * bd_positive / n_frogs, 1), # % bd+ prevalence
    avg_load_bd_pos = round(mean(zsp_eq[infected == 1], na.rm = TRUE), 2)) %>% # avg load for bd+ frogs only
  mutate(
    avg_load_bd_pos = ifelse(is.nan(avg_load_bd_pos), NA, avg_load_bd_pos))  # replace nan with na if no bd+ frogs

swab_ncos_summary <- swab_ncos %>% 
  group_by(code, amphibian_spp, date) %>% # group by site (aka code) and species
  summarise(
    n_frogs = n(), # total frogs swabbed in that site and spp
    bd_positive = sum(infected == 1), # number of bd+ frogs
    prevalence = round(100 * bd_positive / n_frogs, 1), # % bd+ prevalence
    avg_load_bd_pos = round(mean(zsp_eq[infected == 1], na.rm = TRUE), 2)) %>% # avg load for bd+ frogs only
  mutate(
    avg_load_bd_pos = ifelse(is.nan(avg_load_bd_pos), NA, avg_load_bd_pos))  # replace nan with na if no bd+ frogs

swab_summary <- bind_rows(swab_ncos_summary, eb_summary)
```

## VES data

```{r}
# make the df long
ves_long <- ves_may %>%
  dplyr::select(-raxx_adult_or_juvenile) %>%  # remove column of unidentified ranids
  mutate( # sums across the lifestages
    RACA = raca_adult + raca_juvenile,
    RADR = radr_adult + radr_juvenile,
    BUBO = bubo_adult + bubo_juvenile,
    PSRE = psre_adult + psre_juvenile,
    TAXX = taxx_adult + taxx_juvenile) %>%
  select(code = site_code, # make name match the bd df
        RACA, RADR, BUBO, PSRE, TAXX, temp) %>%  # select only needed columns
  pivot_longer(
    cols = c(RACA, RADR, BUBO, PSRE, TAXX),
    names_to = "amphibian_spp",
    values_to = "ves_count") %>% 
   filter(ves_count != 0)  # drop 0s

# add to swab data
bd_ves <- swab_summary %>%
  left_join(ves_long, by = c("code", "amphibian_spp"))
```




# Table

```{r}
table <- bd_ves %>%
  relocate(ves_count, .before = temp) %>% 
   # replace species codes with scientific names
  mutate(amphibian_spp = case_when(
    amphibian_spp == "BUBO" ~ "A. boreas",
    amphibian_spp == "PSRE" ~ "P. regilla",
    amphibian_spp == "RACA" ~ "R. catesbeiana",
    amphibian_spp == "RADR" ~ "R. draytonii",
    TRUE ~ amphibian_spp 
  )) %>%
  arrange(code, amphibian_spp) %>%
  group_by(code) %>%
  ungroup() %>%
  gt() %>%
  cols_label(
    code = "Site",
    date = "Date",
    amphibian_spp = "Species",
    n_frogs = md("Count<br>Swabbed"),
    bd_positive = md("Count<br>Bd+"),
    prevalence = md("Bd<br>Prev (%)"),
    avg_load_bd_pos = md("Ave Bd<br>Load (ZE)"),
    ves_count = md("Count<br>Observed"),
    temp = md("Water<br>Temp (Â°C)")) %>%
  fmt_number(
    columns = c(prevalence, avg_load_bd_pos, temp),
    decimals = 0) %>%
  tab_header(title = "Amphibian Bd Sampling, Observations, Water Temperature (May 2022)") %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())) %>%
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_column_labels(everything())) %>% 
  opt_table_font(font = list(gt::google_font(name = "Helvetica"))) %>% 
   tab_options(
    table.width = pct(100),
    table.font.size = px(10),   
    column_labels.padding = px(2),
    data_row.padding = px(2)
  )

table

gtsave(table, "amphib_table.pdf", vwidth = 1600, vheight = 1000)
```

### summary sentence

Note - no frogs caught at P4, but I guess we saw a toad in the VES

```{r}
n_total_sites <- ves_may %>%
  distinct(site_code) %>%
  nrow()

n_sites_with_swabs <- swab_summary %>%
  distinct(code) %>%
  nrow()

percent_sites_with_swabs <- round(100 * n_sites_with_swabs / n_total_sites, 1)

total_frogs <- sum(swab_summary2$n_frogs, na.rm = TRUE)
total_bd_pos <- sum(swab_summary2$bd_positive, na.rm = TRUE)
overall_prevalence <- round(100 * total_bd_pos / total_frogs, 1)

glue::glue(
  "Amphibians were caught at {percent_sites_with_swabs}% of SFEB sites in May 2022, ",
  "and Bd was detected on frogs with an overall prevalence of {overall_prevalence}% (n = {total_frogs} amphibians)."
)

glue::glue(
  "Amphibians were found at 100% of SFEB sites in May 2022, ",
  "and Bd was detected on frogs with an overall prevalence of {overall_prevalence}% (n = {total_frogs} amphibians)."
)
```

```{r}
n_total_sites <- ves_may %>%
  distinct(site_code) %>%
  nrow()


n_sites_with_frogs <- ves_may %>%
  mutate(taxx_juvenile = as.numeric(taxx_juvenile)) %>%
  rowwise() %>%
  mutate(total_frogs = sum(c_across(raca_adult:taxx_juvenile), na.rm = TRUE)) %>%
  ungroup() %>%
  filter(total_frogs > 0) %>%
  nrow()


percent_sites_with_frogs <- round(100 * n_sites_with_frogs / n_total_sites, 1)

```


# Appendix

```{r}
ncos <- tibble(
  sample_id        = paste0("idr_", 1228:1233),
  sampling_id      = "May_22",
  sample_type      = "swab",
  code             = "NCOS",
  property         = "North Campus Open Space",
  date             = "2/3/21",
  amphibian_spp    = "PSRE",
  amphibian_svl    = c(31, 33, 28, 33, 34, 34),
  amphibian_weight = c(2, 3, 1.5, 2, 2.5, 3.5),
  amphibian_sex    = c("male", "male", NA, "male", "male", "male"),
  amphibian_age    = c("adult", "adult", "juvenile", "adult", "adult", "adult"),
  amphibian_notes  = NA_character_,
  pcr_ct           = c(NA, NA, NA, NA, 28.24, NA),
  pcr_qty          = c(NA, NA, NA, NA, 9.14, NA),
  pcr_ipc_ct       = NA_real_,
  pcr_inhibited    = 0,
  infected         = c(0, 0, 0, 0, 1, 0),
  zsp_eq           = c(NA, NA, NA, NA, 731.15, NA),
  vernal           = 0
)

write_csv(ncos, "ncos_data.csv")

```

