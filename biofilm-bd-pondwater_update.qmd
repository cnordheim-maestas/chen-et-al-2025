---
title: "Biofilm Bd Update"
author: "Caitlin Nordheim-Maestas"
format:
  html:
    toc: true
    code-fold: true
    toc-location: left
---

```{r}
#| warning: false
#| include: false

# Data wrangling

## read in and clean data
library(tidyverse) # for cleaning and viewing data
library(here) # for importing data
library(ggpubr)
library(rstatix)
library(ggplot2)
library(car)
library(multcomp)

ns_biofilm_bd <- read.csv(here("data", "nine-sites-biofilm-on-Bd - Sheet1.csv"))
fs_pw_bd <- read.csv(here("data", "fifteen-sites-PW-on-Bd - Sheet1.csv"))


# data type cleaning

#  Part I
fs_pw_bd$bd_location <- factor(fs_pw_bd$bd_location, levels = c("adherent", "floating"))
fs_pw_bd$filter <- factor(fs_pw_bd$filter,
                          levels = c("40um_filter", "0.22um_filter"))
fs_pw_bd$day <- factor(fs_pw_bd$day, levels = c("1", "7"),
                            labels = c("Day_1", "Day_7"))
fs_pw_bd$site <- factor(fs_pw_bd$site,
                          levels = c("BARN", "CABIN", "NORTH", "GRAMPS", "WEST", "GDPND004", "GDPND005", "GDPND006", "GDPND008", "GDPND009", "PRPND002", "PRPND003", "PRPND004", "PRPND009", "PRPND010", "sterile MQ"))

#  Part II
ns_biofilm_bd$site <- factor(ns_biofilm_bd$site,
                                levels = c("CABIN", "GRAMPS", "WEST", "GDPND005", "GDPND006", "GDPND009", "PRPND004", "PRPND009", "PRPND010"))
ns_biofilm_bd$bd_location <- factor(ns_biofilm_bd$bd_location, levels = c("supernatant", "biofilm"))
ns_biofilm_bd$day <- factor(ns_biofilm_bd$day, levels = c("0", "1", "7"), 
                            labels = c("Day_0", "Day_1", "Day_7")) 
                            
unique(ns_biofilm_bd$site)
# remove the controls
fs_pw_bd <- fs_pw_bd %>%
  filter(site != "sterile MQ")

# no control for nine site expt

```

# Part I: Effect of aquatic environmental microbes on Bd growth - 15 sites

## PI About the data

Wrangled results file name: ["fifteen-sites-PW-on-Bd.csv"](https://docs.google.com/spreadsheets/d/11pCxR2oeprag1EGEAtdYpSmjaPwXD9szq_029p4OB2Q/edit?usp=sharing)

File source: "[Biofilm PCR for R-studio](https://docs.google.com/spreadsheets/d/17QveSH4al14axf-cBsu4JEhgampQEU1E/edit?usp=sharing&ouid=116930126837996341679&rtpof=true&sd=true)" first tab called 15 sites PW on Bd

### Statistical questions:

*NOTE: we need to discuss how we are handling adherent vs floating, I did one test combining and a test on each*

Part I Q1

Is there a difference in the **gain or loss of Bd over 7 days** between the **filter sizes** looking at the **TOTAL BD**

**Answer: There is a significant difference in the change in the total quantity of Bd from Day 1 to Day 7 across the filter types (t = 4.7879, df = 14, p-value = 0.000289)**

Part I Q2

Is there a difference in the **gain or loss of Bd over 7 days** between the **filter sizes** looking at the **ADHERENT BD**

**Answer: There is a significant difference in the change in the adherent Bd from Day 1 to Day 7 across the filter types (t = -5.8588, df = 14, p-value = 4.155e-05)**

 Part I Q3

Is there a difference in the **gain or loss of Bd over 7 days** between the **filter sizes** looking at the **FLOATING BD**

**Answer: Data are not normal enough to test this question for the floating Bd according to qqPlot and shapiro**

This experiment took pond water from 15 East Bay sites in Spring 2022 back to the lab, filtered the pond water to keep or remove the microbes, and added the pond water to lab-cultured Bd-monoculture-biofilms. Two biofilms per water treatment, one destructively sampled day 1, and one destructively sampled day 7 for qPCR quantification of Bd in the supernatant and the biofilm itself.

## PI Data visualization

### Renwei barplot

Discussion points: Color preferences? And consider if we arent distinguishing bw floating and adherent, can make a simpler plot with just the total Bd, filter, and day, and can do a side by side boxplot with day to clearly show the difference and only one facet. Also labels: do we want it to be "with microbes" and "without microbes"?

```{r}
fs_pw_bd %>%
ggplot(aes(y= log10(bd_qty + 1), x = site, fill=bd_location)) + 
    geom_col() +
    facet_grid(day~filter)+
    #theme_classic() +
   theme(axis.text.x = element_text(angle = 90),
          legend.position = "bottom") + 
    xlab("Site") +
    ylab("Bd Quantity \n (log + 1 transformed zoospore equivalents)")
  ggtitle("Effect of aquatic environmental microbes on Bd growth")
```

## PI Stats and assumption testing

Question:

Does the difference in Bd from day 1 to day 7 differ between the two filter types?

The samples are essentially paired by site, so a paired t-test is most appropriate

$H0:Î¼_{difference in Bd}=0$

Assumptions:

Assumes that the observations from each group represent a random sample from the population. Assumes that the difference of the two observations follow a normal distribution.

Plan: 3 paired t-tests: Simplest: combining floating and not floating Bd, then more complex: One for adherent, one for floating, then let Cherie and Renwei choose which is most appropriate

### Part I Q1: Paired t-test on the difference in all of the Bd from day 1 to day 7 between the two filters

**There is a significant difference in the change in the total quantity of Bd from Day 1 to Day 7 across the filter types (t = 4.7879, df = 14, p-value = 0.000289)**

```{r}
# Assumptions testing

# Step 1: combine floating and floating
fs_wider_combined <- fs_pw_bd %>%
  pivot_wider(names_from = bd_location, values_from = bd_qty) %>%
  mutate(combined_bd = adherent + floating)

fs_wider_combined <- subset(fs_wider_combined, select = -c(adherent,floating) )

fs_wider_combined <- fs_wider_combined %>% 
  # calculate diff
  pivot_wider(names_from = day, values_from = combined_bd) %>%
  mutate(diff = Day_1 - Day_7)

# Step 2: create subsets for each treatment
fs_wider_combined_40um <- fs_wider_combined %>% 
  filter(filter =="40um_filter")
fs_wider_combined_.22um <- fs_wider_combined %>% 
  filter(filter =="0.22um_filter")

# Step 3: check normality of the differences across groups
fs_wider_combined_40um %>% 
 ggqqplot("diff", title = "Untransformed Bd in both floating and floating diff between day 1 and 7 qqPlot") # good enough
shapiro.test(fs_wider_combined_40um$diff) # normal, yay!
hist(fs_wider_combined_40um$diff) # good enough

fs_wider_combined_.22um %>% 
 ggqqplot("diff", title = "Untransformed Bd in both floating and floating diff between day 1 and 7 qqPlot") # gorgeous
shapiro.test(fs_wider_combined_.22um$diff) # normal, yay!
hist(fs_wider_combined_.22um$diff) # good enough
  
```

Stats: 

```{r}
# Step 3: run the paired t-test on the difference
t.test(fs_wider_combined_40um$diff, fs_wider_combined_.22um$diff, paired = TRUE)
```


### Part I Q2: Paired t-test on the difference in floating Bd from day 1 to day 7 between the two filters

**There is a significant difference in the change in the adherent Bd from Day 1 to Day 7 across the filter types (t = -5.8588, df = 14, p-value = 4.155e-05)**

```{r}
# Step 1: SELECT ONLY adherent BD and calculate the diff between day 1 and 7
fs_adherent_wide <- fs_pw_bd %>%
  filter(bd_location =="adherent") %>% 
  # calculate diff
  pivot_wider(names_from = day, values_from = bd_qty) %>%
  mutate(diff = Day_1 - Day_7)

# Step 2: create subsets for each treatment
fs_adherent_wide_40 <- fs_adherent_wide %>% 
  filter(filter =="40um_filter")
fs_adherent_wide_.22 <- fs_adherent_wide %>% 
  filter(filter =="0.22um_filter")

# Step 3: check normality of the differences across groups
fs_adherent_wide_40  %>% 
 ggqqplot("diff", title = "Untransformed Bd in both adherent and adherent diff between day 1 and 7 qqPlot") # perf
shapiro.test(fs_adherent_wide_40 $diff) # normal, yay!
hist(fs_adherent_wide_40 $diff) # good enough

fs_adherent_wide_.22 %>% 
 ggqqplot("diff", title = "Untransformed Bd in both adherent and adherent diff between day 1 and 7 qqPlot") # gorgeous
shapiro.test(fs_adherent_wide_.22$diff) # normal, yay!
hist(fs_adherent_wide_.22$diff) # good enough
  
```

Stats:

```{r}
# Step 3: run the paired t-test on the difference
t.test(fs_adherent_wide_.22$diff, fs_adherent_wide_40$diff, paired = TRUE)
```


### Part I Q3: Paired t-test on the difference in FLOATING Bd from day 1 to day 7 between the two filters

**Floating Bd alone is not normally distrubuted, violates the test assumptions**

If this is an important question, need to determine transformation (log of the neg difference (aka gain in floating Bd is throwing NaN's)

```{r}
par(mfrow = c(2, 2))

# Step 1: SELECT ONLY floating BD and calculate the diff between day 1 and 7
fs_floating_wide <- fs_pw_bd %>%
  filter(bd_location =="floating") %>% 
  # calculate diff
  pivot_wider(names_from = day, values_from = bd_qty) %>%
  mutate(diff = Day_1 - Day_7)

# Step 2: create subsets for each treatment
fs_floating_wide_40 <- fs_floating_wide %>% 
  filter(filter =="40um_filter")
fs_floating_wide_.22 <- fs_floating_wide %>% 
  filter(filter =="0.22um_filter")

# Step 3: check normality of the differences across groups
qq1 <- qqPlot(fs_floating_wide_40$diff) # NOPE
shapiro.test(fs_floating_wide_40$diff) # NOPE
hist40 <- hist(fs_floating_wide_40$diff) # NOPE 

## could log transform and try again if it is of interest
qq2 <- qqPlot(fs_floating_wide_.22$diff)
shapiro.test(fs_floating_wide_.22$diff) # normal, yay!
hist20 <- hist(fs_floating_wide_.22$diff) # good enough
  
# Step 3: run the paired t-test on the difference
#t.test(fs_floating_wide_.22$diff, fs_floating_wide_40$diff, paired = TRUE)

```


# Part II: Effect of the aquatic environmental biofilm on Bd growth - "9 sites"

Wrangled results file name: ["nine-sites-biofilm-on-Bd.csv"](https://docs.google.com/spreadsheets/d/1YCU_tCge48MhDw7cMfYAZYokpwAVHtkaY7rfrC5jUDg/edit#gid=0)

File source: "[Biofilm PCR for R-studio](https://docs.google.com/spreadsheets/d/17QveSH4al14axf-cBsu4JEhgampQEU1E/edit?usp=sharing&ouid=116930126837996341679&rtpof=true&sd=true)" first tab called 9 sites Biofilm on Bd

### Statisical questions

Part II Q1: Is there a difference in Bd quantity total between day 0, 1, 7? - repeated measures anova

**There is a significant difference in the amount of log Bd total across the days (p = 1.01e-11). Day 0 and Day 1 differ (p = 2.48e-05), Day 1 and Day 7 differ (p = 1.35e-05), Day 0 and Day 7 differ (p = 5.82e-07)**

Part II Q2: Is there a difference in Bd quantity in the biofilm between day 0, 1, 7? - repeated measures anova

**STOP: DOES NOT PASS NORMALITY ASSUMPTION FOR DAY 0!!!** Discuss alternative tests?

Part II Q3: Is there a difference in Bd quantity in the supernatant between day 0, 1, 7? - repeated measures anova

**There is a significant difference in the amount of log Bd in the supernatant across the days (p = 5.15e-10). Day 0 and Day 1 differ (p = 2.06e-05), Day 1 and Day 7 differ (p = 3.75e-04	), and Day 0 and Day 7 differ (p = 3.36e-06	)**

## PII Data visualization

### Renwei barplot

```{r}
ns_biofilm_bd %>%
ggplot(aes(y= log10(bd_qty), x = site, fill=bd_location)) + 
    geom_col() +
    facet_grid(.~day)+
    theme(axis.text.x = element_text(angle = 90),
          legend.position = "bottom") + 
    xlab("Site") +
   ylab("Bd Quantity \n (log transformed zoospore equivalents)") +
  ggtitle("Lab Bd innoculation on East Bay Biofilms - 9 sites") 
```

## PII Assumptions testing and Stats

Repeated Measures ANOVA

Unfamiliar test and function to me, followed this tutorial: https://www.datanovia.com/en/lessons/repeated-measures-anova-in-r/

### Q1: In total Bd, is there a diff across days 0, 1, 7?

**There is a significant difference in the amount of log Bd total across the days (p = 1.01e-11). Day 0 and Day 1 differ (p = 2.48e-05), Day 1 and Day 7 differ (p = 1.35e-05), Day 0 and Day 7 differ (p = 5.82e-07)**

```{r}
# Step 1: combine floating and floating
combined <- ns_biofilm_bd %>%
  pivot_wider(names_from = bd_location, values_from = bd_qty) %>%
  mutate(combined_bd = biofilm + supernatant) %>% 
  mutate(log_combined_bd = log(combined_bd))

# assumptions
combined %>%
  group_by(day) %>%
  #shapiro_test(combined_bd) %>%  # SO DAMN CLOSE without transformation
  shapiro_test(log_combined_bd) # def normal


# anova
res.aov <- anova_test(data = combined, dv = log_combined_bd, wid = site, within = day)
get_anova_table(res.aov) # ges is the generalized effect size (amount of variability due to the within-subjects factor)

# post hoc pairwise comparison: pairwise ttest with bonferroni correction
pwc <-combined %>%
  pairwise_t_test(
    log_combined_bd ~ day, paired = TRUE,
    p.adjust.method = "bonferroni"
    )
pwc



```

### Q2: In biofilms, is there a diff across days 0, 1, 7?

**STOP: DOES NOT PASS NORMALITY ASSUMPTION FOR DAY 0!!!**

```{r}
biofilm_only <- ns_biofilm_bd %>%
  filter(bd_location == "biofilm") %>%
  mutate(log_qty = log(bd_qty))

# assumptions tests
biofilm_only %>%
  group_by(day) %>%
  shapiro_test(log_qty) # day 0 does not pass

# anova

res.aov <- anova_test(data = biofilm_only, dv = log_qty, wid = site, within = day)
get_anova_table(res.aov) # ges is the generalized effect size (amount of variability due to the within-subjects factor)

# post hoc pairwise comparison: pairwise ttest with bonferroni correction
pwc <- ns_biofilm_bd %>%
  filter(bd_location == "biofilm") %>%
  mutate(log_qty = log(bd_qty +1)) %>%
  pairwise_t_test(
    log_qty ~ day, paired = TRUE,
    p.adjust.method = "bonferroni"
    )
pwc

```


### Q3: In supernatant, is there a diff across days 0, 1, 7?

**There is a significant difference in the amount of log Bd in the supernatant across the days (p = 5.15e-10). Day 0 and Day 1 differ (p = 2.06e-05), Day 1 and Day 7 differ (p = 3.75e-04	), and Day 0 and Day 7 differ (p = 3.36e-06	)**

```{r}

s_only <- ns_biofilm_bd %>%
  filter(bd_location == "supernatant") %>%
  mutate(log_qty = log(bd_qty))

# assumptions
s_only %>%
  group_by(day) %>%
  shapiro_test(log_qty) #passes

# anova
res.aov <- anova_test(data = s_only, dv = log_qty, wid = site, within = day)
get_anova_table(res.aov) # ges is the generalized effect size (amount of variability due to the within-subjects factor)

# post hoc pairwise comparison: pairwise ttest with bonferroni correction
pwc <-s_only %>%
  pairwise_t_test(
    log_qty ~ day, paired = TRUE,
    p.adjust.method = "bonferroni"
    )
pwc

```


## Discuss with group: normality assumption, how would we want to structure a glm type model to properly account for site while  accounting for the "paired" apsect of the experiment?

## EDA's

## PI EDA

Boxplot of Bd quantity across days #1

```{r}
fs_pw_bd %>%
  ggplot(aes(x = day, y = log(bd_qty +1), fill = bd_location)) +
  geom_boxplot() +
  theme_classic() +
  theme(axis.title = element_text(size = 12, face = "bold"),
        legend.position = "bottom") +
  ggtitle("15 sites ")

fs_pw_bd %>%
  ggplot(aes(x = day, y = log(bd_qty +1), fill = bd_location)) +
  geom_boxplot() +
  theme_classic() +
  theme(axis.title = element_text(size = 12, face = "bold"),
        legend.position = "bottom") +
  facet_wrap(~filter) +
  ggtitle("15 sites ")

```

Overarching question: Does the amount of Bd in the biofilm or supernatant differ across days?

## P2 

Boxplot of Bd quantity across days #1

```{r}
ns_biofilm_bd %>%
  ggplot(aes(x = day, y = log(bd_qty +1), fill = bd_location)) +
  geom_boxplot() +
  theme_classic() +
  theme(axis.title = element_text(size = 12, face = "bold"),
        legend.position = "bottom") +
  ggtitle("Lab Bd innoculation on East Bay Biofilms - '9 sites' ")

```

Boxplot of Bd quantity across days #2: faceted by Bd location to show trends within Bd location

```{r}
ns_biofilm_bd %>%
  ggplot(aes(x = day, y = log(bd_qty +1), fill = bd_location)) +
  geom_boxplot() +
  theme_classic() +
  facet_wrap(~bd_location) +
  theme(axis.title = element_text(size = 12, face = "bold"),
        legend.position = "bottom") +
  ggtitle(" Lab Bd innoculation on East Bay Biofilms - '9 sites' ")
```

Let's look at the distributions of the Bd in biofilms and supernatant

```{r}
# all data biofilms
ns_biofilm_bd %>%
  filter(bd_location == "biofilm") %>% #filter out only bd in biofilm
  ggplot(aes(x = log(bd_qty +1))) +
  geom_histogram(position = "identity",  bins=30) +
  theme_classic() +
  theme(axis.title = element_text(size = 12, face = "bold")) +
  ggtitle("Bd in BIOFILMS from 9 site experiment")

# faceted by day
ns_biofilm_bd %>%
  filter(bd_location == "biofilm") %>% #filter out only bd in biofilm
  ggplot(aes(x = log(bd_qty +1))) +
  geom_histogram(position = "identity",  bins=30) +
  facet_wrap(~day) +
  theme_classic() +
  theme(axis.title = element_text(size = 12, face = "bold")) +
  ggtitle("Bd in BIOFILMS from 9 site experiment")

# all data supernatant
ns_biofilm_bd %>%
  filter(bd_location == "supernatant") %>% #filter out only bd in biofilm
  ggplot(aes(x = log(bd_qty +1))) +
  geom_histogram(position = "identity",  bins=30) +
  theme_classic() +
  theme(axis.title = element_text(size = 12, face = "bold")) +
  ggtitle("Bd in SUPERNATANT from 9 site experiment")

# faceted by day
ns_biofilm_bd %>%
  filter(bd_location == "supernatant") %>% #filter out only bd in biofilm
  ggplot(aes(x = log(bd_qty +1))) +
  geom_histogram(position = "identity", bins=30) +
  facet_wrap(~day) +
  theme_classic() +
  theme(axis.title = element_text(size = 12, face = "bold")) +
  ggtitle("Bd in SUPERNATANT from 9 site experiment")

```

Now let's check out the qqPlots of Bd in biofilms and supernatant

```{r}
# whole dataset
ns_biofilm_bd %>%
  filter(bd_location == "biofilm") %>%
  mutate(log_qty = log(bd_qty +1)) %>%
ggqqplot("log_qty", title = "Bd in biofilm qqPlot")

# per day
ns_biofilm_bd %>%
  filter(bd_location == "biofilm") %>%
  mutate(log_qty = log(bd_qty +1)) %>%
ggqqplot("log_qty", facet.by = "day", title = "Bd in biofilm qqPlot")

# difference between day 1 and day 7
ns_biofilm_bd %>%
  filter(bd_location == "biofilm") %>%
  pivot_wider(names_from = day, values_from = bd_qty) %>%
  mutate(diff = Day_1 - Day_7) %>%
  mutate(log_diff = log(diff +1)) %>%
  ggqqplot("log_diff", title = "Bd in biofilm diff between day 1 and 7 qqPlot")

# whole dataset
ns_biofilm_bd %>%
  filter(bd_location == "supernatant") %>%
  mutate(log_qty = log(bd_qty +1)) %>%
ggqqplot("log_qty", title = "Bd in SUPERNATANT qqPlot")

# per day
ns_biofilm_bd %>%
  filter(bd_location == "supernatant") %>%
  mutate(log_qty = log(bd_qty +1)) %>%
ggqqplot("log_qty", facet.by = "day", title = "Bd in SUPERNATANT qqPlot")

# difference between day 1 and day 7
ns_biofilm_bd %>%
  filter(bd_location == "supernatant") %>%
  pivot_wider(names_from = day, values_from = bd_qty) %>%
  mutate(diff = Day_1 - Day_7) %>%
  mutate(log_diff = log(diff +1)) %>%
  ggqqplot("log_diff", title = "Bd in supernatant diff between day 1 and 7 qqPlot")

```

```{r}
#| include: false


# shapiro - wilks test: all Bd biofilm
ns_biofilm_bd %>%
  filter(bd_location == "biofilm") %>%
  mutate(log_bd_qty = log(bd_qty +1)) %>%
  group_by(day) %>%
  shapiro_test(log_bd_qty) # day 0 not normal

# shapiro - wilks test: difference in day 1 and day 7
ns_biofilm_bd %>%
  filter(bd_location == "biofilm") %>%
  pivot_wider(names_from = day, values_from = bd_qty) %>%
  mutate(diff = Day_1 - Day_7) %>%
  mutate(log_diff = log(diff +1)) %>%
  shapiro_test(log_diff) # normal

```

```{r}
#| include: false


#### paired t-test between day 1 and 7
d1 <- ns_biofilm_bd %>% 
  filter(bd_location == "biofilm") %>%
  filter(day == "Day_1")

d7 <- ns_biofilm_bd %>% 
  filter(bd_location == "biofilm") %>%
  filter(day == "Day_7")

t.test(d1$bd_qty, d7$bd_qty, paired = TRUE)
```

```{r}
#| include: false


# shapiro - wilks test: all Bd biofilm
ns_biofilm_bd %>%
  filter(bd_location == "supernatant") %>%
  mutate(log_bd_qty = log(bd_qty +1)) %>%
  group_by(day) %>%
  shapiro_test(log_bd_qty) # all good

# shapiro - wilks test: difference in day 1 and day 7
ns_biofilm_bd %>%
  filter(bd_location == "supernatant") %>%
  pivot_wider(names_from = day, values_from = bd_qty) %>%
  mutate(diff = Day_1 - Day_7) %>%
  mutate(log_diff = log(diff +1)) %>%
  shapiro_test(log_diff) # normal

```


```{r}
#| include: false

#### paired t-test between day 1 and 7
d1 <- ns_biofilm_bd %>% 
  filter(bd_location == "supernatant") %>%
  filter(day == "Day_1")

d7 <- ns_biofilm_bd %>% 
  filter(bd_location == "supernatant") %>%
  filter(day == "Day_7")

t.test(d1$bd_qty, d7$bd_qty, paired = TRUE)
```
