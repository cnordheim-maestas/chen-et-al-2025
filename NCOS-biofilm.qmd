---
title: "NCOS biofilm"
author: "Caitlin Nordheim-Maestas"
format:
  html:
    toc: true
    code-fold: true
    toc-location: left
---

# Goal: Re-create Renwei's visualizations in R and run stats across treatments and time

See Renwei's excel version here: <https://drive.google.com/file/d/1Dy_jAW0lTQZohf7V-l5VxQ_LrNLP9Aai/view?usp=sharing>

```{r}
#| warning: false

## read in and clean data
library(tidyverse) # for cleaning and viewing data
library(here) # for importing data
library(ggpubr)
library(rstatix)
library(ggplot2)
library(car)
library(multcomp)
library(nlme)
library(emmeans)

fig_2b_raw <- read.csv(here("data", "final_NCOS_2024_reformatted_for_R.xlsx - Fig2B.csv"))
fig_3b_raw <- read.csv(here("data", "final_NCOS_2024_reformatted_for_R.xlsx - Fig3B.csv"))
fig_4b_raw <- read.csv(here("data", "final_NCOS_2024_reformatted_for_R.xlsx - Fig4B.csv"))

with_microbes_40_color <- "#999933"
no_microbes_.22_color <- "#88ccee"
```

Custom theme

```{r}
myCustomTheme <- function() {
  theme_minimal() +
    theme(axis.text = element_text(size = 12, family = "Times"),
          axis.title = element_text(size = 14, face = "bold", family = "Times"),
          axis.title.y = element_text(margin = margin(r = 10), size = 14, face = "bold", family = "Times"), # Add space between y-axis label and axis
          title = element_text(size = 12, face = "bold", family = "Times"),
          plot.caption = element_text(size = 10, face = "italic", family = "Times"),
          legend.text = element_text(size = 10, family = "Times"), # Increase legend text size
          panel.grid.major.x = element_blank(), # Remove major vertical grid lines
          panel.grid.minor.x = element_blank()) # Remove minor vertical grid lines
}
```

# Data reformatting and cleaning

```{r}
## 2B
# add column for microbes or no
pw <- fig_2b_raw %>% 
  mutate(microbes = case_when(
    str_detect(sample_ID, "\\+microorganism") ~ "y",
    TRUE ~ "n"
  )) %>% 
  # add column for TB or no
  mutate(TB = case_when(
    str_detect(sample_ID, "TB") ~ "y",
    TRUE ~ "n"
  )) %>% 
  # add column for PW or no
  mutate(PW = case_when(
    str_detect(sample_ID, "PW") ~ "y",
    TRUE ~ "n"
  ))


## aquatic environmental biofilm (4b but I think its supposed to be 3b)
# add column for microbes or no
ae <- fig_3b_raw %>% 
  rename(sample_ID = Adherent.sample.ID) %>% 
  
  # add columns for components y/n
  # add column for TB or no
  mutate(TB = case_when(
    str_detect(sample_ID, "TB") ~ "y",
    TRUE ~ "n"
  )) %>% 
  # add column for PW or no
  mutate(PW = case_when(
    str_detect(sample_ID, "PW") ~ "y",
    TRUE ~ "n"
  ))

## Monolayer (3b but I think its supposed tobe 4b)
# add column for microbes or no
monolayer <- fig_4b_raw %>% 
  rename(sample_ID = sample.ID) %>% 
  rename(adh_plus_sup = ahd_plus_sup) %>% 
  # rename sample_id to only include treatment, not day
  mutate(sample_ID = str_replace(sample_ID, "-D[0-9]+$", "")) %>% 

  # add columns for components y/n
  mutate(microbes = case_when(
    str_detect(sample_ID, "\\+microbes") ~ "y",
    TRUE ~ "n"
  )) %>% 
  # add column for TB or no
  mutate(TB = case_when(
    str_detect(sample_ID, "TB") ~ "y",
    TRUE ~ "n"
  )) %>% 
  # add column for PW or no
  mutate(PW = case_when(
    str_detect(sample_ID, "PW") ~ "y",
    TRUE ~ "n"
  ))


```

# 2b: Pond water

I am not sure what the experimental set up is, but here is a re-creation of Renwei's excel figure.

It looks like solid lines are with microbes and dashed lines are without microbes

## Over time

### Renwei's figure

![](data/fig_2b_Renweiexcelversion.jpg){fig-align="left" width="4in"}

### gut check: ggplot version: replicating Renwei's

```{r}
pw_summary <- pw %>% 
  group_by(day, sample_ID) %>% 
  reframe(mean = mean(adh_plus_sup), # calculate the mean
            n = length(adh_plus_sup), # count the number of observations
            df = n - 1, # calculate the degrees of freedom
            sd = sd(adh_plus_sup), # calculate the standard deviation
            se = sd/sqrt(n), # calculate the standard error
          ) %>% 
  mutate(microbes = case_when(
    str_detect(sample_ID, "\\+microorganism") ~ "y",TRUE ~ "n")) %>% 
  # add column for TB or no
  mutate(TB = case_when(str_detect(sample_ID, "TB") ~ "y", TRUE ~ "n")) %>% 
  # add column for PW or no
  mutate(PW = case_when(str_detect(sample_ID, "PW") ~ "y", TRUE ~ "n")) 

pw_summary %>% 
  # reorder to match Renwei's plot
  mutate(sample_ID = factor(sample_ID, 
                            levels = c("1%TB", "MQ", "1%TB+PW+microorganism", "PW+microorganism", "1%TB+PW-microorganism", "PW-microorganism", "Added Bd"))) %>% 

  ggplot(aes(x = day, 
           y = mean, 
           color = sample_ID)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - se, # plot the standard error
                    ymax = mean + se),
                width = 0.1) +
    geom_line(aes(linetype = microbes)) + 
  scale_y_log10(limits = c(1e3, 1e8), 
                breaks = c(1e3, 1e4, 1e5, 1e6, 1e7, 1e8)) +
  # vibes
  labs(x = "Day",
       y = "Bd Quantity per sample (ZE/well)",
       title = "Sanity check: Replicating Renwei version exactly",
       caption = "supernatant plus adherent visualized here") +
  scale_color_manual(values = c("1%TB" = "goldenrod", 
                                "MQ" = "blue", 
                                "1%TB+PW+microorganism" = "darkolivegreen3", 
                                "PW+microorganism" = "magenta", 
                                "1%TB+PW-microorganism" = "palegreen4", 
                                "PW-microorganism" = "palevioletred1",
                                "Added Bd" = "darkgrey")) + # Assign specific colors to match RC's plot
  scale_linetype_manual(values = c("n" = "dashed", 
                                   "y" = "solid")) +
theme_minimal() +
  scale_x_continuous(breaks = c(0, 1, 3, 5, 7))
```

## Caitlin's version

Used colorblind friendly palette

```{r}
pw_summary <- pw %>% 
  group_by(day, sample_ID) %>% 
  reframe(mean = mean(adh_plus_sup), # calculate the mean
            n = length(adh_plus_sup), # count the number of observations
            df = n - 1, # calculate the degrees of freedom
            sd = sd(adh_plus_sup), # calculate the standard deviation
            se = sd/sqrt(n), # calculate the standard error
          ) %>% 
  mutate(microbes = case_when(
    str_detect(sample_ID, "\\+microorganism") ~ "y",TRUE ~ "n")) %>% 
  # add column for TB or no
  mutate(TB = case_when(str_detect(sample_ID, "TB") ~ "y", TRUE ~ "n")) %>% 
  # add column for PW or no
  mutate(PW = case_when(str_detect(sample_ID, "PW") ~ "y", TRUE ~ "n")) 

pw_summary %>% 
  # reorder to match Renwei's plot
  mutate(sample_ID = factor(sample_ID, 
                            levels = c("1%TB", "MQ", "1%TB+PW+microorganism", "PW+microorganism", "1%TB+PW-microorganism", "PW-microorganism", "Added Bd"))) %>% 

  ggplot(aes(x = day, 
           y = mean, 
           color = sample_ID)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - se, # plot the standard error
                    ymax = mean + se),
                width = 0.1) +
  scale_y_log10(limits = c(1e3, 1e8), 
                breaks = c(1e3, 1e4, 1e5, 1e6, 1e7, 1e8)) +
  # vibes
 # vibes
  labs(x = "Day",
       y = "Bd Quantity per sample (ZE/well)",
       color = "Medium",       # Title for color legend
       linetype = "Microbes Present"  # Title for linetype legend
       ) +
  scale_color_manual(values = c("1%TB" = "#CCBB44", 
                                "MQ" = "#228833", 
                                "1%TB+PW+microorganism" = "#4477AA", 
                                "PW+microorganism" = "#EE6677", 
                                "1%TB+PW-microorganism" = "#66CCEE", 
                                "PW-microorganism" = "#AA3377",
                                "Added Bd" = "#BBBBBB"),  # Assign specific colors to match RC's plot
                    labels = c("1%TB" = "TB",
                                "MQ" = "MQ",
                                "1%TB+PW+microorganism" = "TB + PW + MO",
                                "PW+microorganism" = "PW + MO",
                                "1%TB+PW-microorganism" = "TB + PW - MO",
                                "PW-microorganism" = "PW - MO",
                                "Added Bd" = "Initial Bd")) + # Custom labels for the color legend
    geom_line(aes(linetype = microbes)) + 
  scale_linetype_manual(values = c("n" = "dashed", 
                                   "y" = "solid"),
                        labels = c("n" = "N", "y" = "Y")) +  # Change labels to uppercase N and Y
 myCustomTheme()+
  scale_x_continuous(breaks = c(0, 1, 3, 5, 7)) +
  theme(legend.position = "right") # Adjust the legend position to overlap with the plot
```

## 2b EDA

## boxplot match East Bay experiment, let's remove TB for now

Interesting, in NCOS, by day 1, there was already decline in the amount of Bd in the microbes treatment, unlike in the Bay, where the decline took more time

```{r}
pw %>% 
  filter(day != 0 ) %>%
  filter(TB != "y") %>% # remove all treatments with TB broth
 # filter(day != 3 & day != 5) %>% 
  
  ggplot(aes(y= adh_plus_sup, x = sample_ID, fill = sample_ID)) + 
    geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.3) +
  scale_y_log10() + 
   facet_wrap(~day, nrow = 1, labeller = labeller(day = c("1" = "Day 1", "3" = "Day 3", 
                                                          "5" = "Day 5", "7" = "Day 7"))) +
    scale_fill_manual(values = c("PW+microorganism" = with_microbes_40_color, 
                                "PW-microorganism" = no_microbes_.22_color,
                                
                                "MQ" = "darkgrey")) +
  scale_x_discrete (labels= c("PW+microorganism" = "Present", "PW-microorganism" = "Absent", "MQ" = "Control")) +
  labs(x = "Presence of microbes in pond water",
       y = "Bd Quantity per sample (ZE/well)",
       title = "NCOS data from tab called fig 2b",
       caption = "supernatant plus adherent visualized here") +
  theme_classic() +
   theme(legend.position = "none",
         strip.text = element_text(face="bold"),
         axis.title = element_text(face = "bold"))
```

This will allow for the p-values differentiating days and microbe presence absence if that is wanted

### visualize y var: bd load

```{r}
# untransformed
pw_noday0 <- pw %>% 
  filter(day != 0) %>% 
  mutate(log_adh_plus_sup = log(adh_plus_sup)) # note: no zeroes so not log + 1
ggqqplot(pw_noday0, "adh_plus_sup", title = "untransformed")
shapiro.test(pw_noday0$adh_plus_sup) # nope
hist(pw_noday0$adh_plus_sup) # note

# transformed
ggqqplot(pw_noday0, "log_adh_plus_sup", title = "log transformed") # gorgeous
hist(pw_noday0$log_adh_plus_sup) # better
shapiro.test(pw_noday0$log_adh_plus_sup) # p-value = 0.01361, does not pass shapiro, but this has an n of 72 which is more than the recommended <50 samples

```

## 2b Stats

y var: amount of Bd

x vars: day, treatment, microbes y/n, pw y/n, tb y/n

Best model: Bd \~ day\*microbes\*TB

Question: Does the amount of Bd in the sample differ across the treatments of presence of microbes, TB, and day?

Model: 3-way ANOVA

Answer: Yes, there is a significant effect of day, presence of microbes, presence of TB as well as the interactions between day and microbes, day and TB, and a third-order interaction of day, microbes, and TB (three-way ANOVA, I recommend using a results table, it's a lot of p and f and df values to list)

First-order comparisons:

Samples with: the presence of microbes are associated with lower Bd with TB have higher Bd days 1-7 and 3-7 are different, with day 1 having higher Bd than day 3 and day 3 having higher bd than day 7

I dont recommend writing out all second-order and third-order comparisons, but you can say something like there is an influence of the interaction of microbes and the day, and TB and the day.

```{r}
# quick check: we want day as a FACTOR
pw_noday0 <- pw_noday0 %>% 
  mutate(day = as.factor(day))
str(pw_noday0$day)

# set MQ as reference
pw_noday0$sample_ID <- factor(pw_noday0$sample_ID)
pw_noday0$sample_ID <- relevel(pw_noday0$sample_ID, ref = "MQ")
```

## null

```{r}
null <- lm(log_adh_plus_sup ~ 1,
  data = pw_noday0)
AIC(null) #326.4356

```

## Best model: Bd \~ day\*microbes\*TB

Q: is it more appropriate to also do random effect of treatment? We can try it

```{r}
# build model
mod3 <- aov(log_adh_plus_sup ~ day*microbes*TB,
  data = pw_noday0)

# diagnostic plot
par(mfrow = c(2,2))
plot(mod3) # looks good

# look at results
summary(mod3)
anova(mod3) # day, microbes, tb are all significant, interactions: day:TB, day:microbes, day:microbes:TB, NOT microbes:TB 
AIC(mod3) # 161.4887 BEST MODEL

TukeyHSD(mod3)

# comparisons
em <- emmeans(mod3, ~ day * microbes * TB)
# Perform the Tukey test for pairwise comparisons
tukey_results <- contrast(em, method = "tukey")
# View the results
summary(tukey_results)

```

## Bd \~ day + treatment

If it is important to you to have p-values comparing at the treatment level, you can use this instead, but I think it provides less information than the model above, and it has a higher aic value

Significant Contrasts (p-value \< 0.05):

1.  **MQ - (1%TB+PW+microorganism)**: p-value = `<.0001`
2.  **MQ - (PW+microorganism)**: p-value = `<.0001`
3.  **1%TB - (1%TB+PW+microorganism)**: p-value = `<.0001`
4.  **1%TB - (PW+microorganism)**: p-value = `<.0001`
5.  **(1%TB+PW-microorganism) - (1%TB+PW+microorganism)**: p-value = `<.0001`
6.  **(1%TB+PW-microorganism) - (PW+microorganism)**: p-value = `<.0001`
7.  **(1%TB+PW+microorganism) - (PW-microorganism)**: p-value = `<.0001`
8.  **(PW-microorganism) - (PW+microorganism)**: p-value = `<.0001`

Non-Significant Contrasts (p-value ≥ 0.05):

1.  **MQ - 1%TB**: p-value = `0.3017`
2.  **MQ - (1%TB+PW-microorganism)**: p-value = `0.0500` (marginal significance)
3.  **MQ - (PW-microorganism)**: p-value = `0.9917`
4.  **1%TB - (1%TB+PW-microorganism)**: p-value = `0.9586`
5.  **1%TB - (PW-microorganism)**: p-value = `0.6577`
6.  **(1%TB+PW-microorganism) - (PW-microorganism)**: p-value = `0.1888`
7.  **(1%TB+PW+microorganism) - (PW-microorganism)**: p-value = `0.1940`

```{r}
# build model
mod <- lm(log_adh_plus_sup ~ day + sample_ID,
  data = pw_noday0)

# diagnostic plot
par(mfrow = c(2,2))
plot(mod)

# look at results
summary(mod)
anova(mod) # day is significant, sample id is too
AIC(mod) # 237.1393

# comparisons by day
emmeans::emmeans(mod, pairwise ~ day) # pairwise comparisons

# comparisons by treatment
emmeans::emmeans(mod, pairwise ~ sample_ID) # pairwise comparisons
```

## No interactions: Bd \~ day + microbes + PW + TB

This is nt a great model, but I kept it for yall to see

```{r}
# build model
mod2 <- lm(log_adh_plus_sup ~ day + microbes + PW + TB,
  data = pw_noday0)

# diagnostic plot
par(mfrow = c(2,2))
plot(mod2) # looks better tbh

# look at results
summary(mod2)
anova(mod2) # day, microbes, tb are all significant
AIC(mod2) # 233.1865 better model!

# comparisons
emmeans::emmeans(mod2, pairwise ~ day) # same pattern as previous model, day 1-7 and 3-7
emmeans::emmeans(mod2, pairwise ~ microbes) # microbes p <.0001, no microbes sig more
emmeans::emmeans(mod2, pairwise ~ TB) # TB p = 0.0002, with TB is sig more

```

# 3b Aquatic environmental biofilm on Bd growth:

All microbe-depleted, NO microbe+ treatment (from RC's 3b figure legend)

### Renwei's figure

![](data/3bRenwei.jpg){width="4in"}

### ggplot version: replicating Renwei's AE

```{r}
ae_summary <- ae %>%
  group_by(day, sample_ID) %>%
  reframe(mean = mean(adh), # calculate the mean
            n = length(adh), # count the number of observations
            df = n - 1, # calculate the degrees of freedom
            sd = sd(adh), # calculate the standard deviation
            se = sd/sqrt(n), # calculate the standard error
          ) %>%
  # add column for TB or no
  mutate(TB = case_when(str_detect(sample_ID, "TB") ~ "y", TRUE ~ "n")) %>%
  # add column for PW or no
  mutate(PW = case_when(str_detect(sample_ID, "PW") ~ "y", TRUE ~ "n"))

ae_summary %>%
  # reorder to match Renwei's plot
  mutate(sample_ID = factor(sample_ID,
                            levels = c("1%TB+AEbiofilm", "MQ+AEbiofilm",
                                       "PW+AEBiofilm",   "Added Bd"  ))) %>%

  ggplot(aes(x = day,
           y = mean,
           color = sample_ID)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - se, # plot the standard error
                    ymax = mean + se),
                width = 0.1) +
  geom_line() + 
  scale_y_log10(limits = c(1e3, 1e7),
                breaks = c(1e3, 1e4, 1e5, 1e6, 1e7)) +
  # vibes
  labs(x = "Day",
       y = "Bd Quantity per sample (ZE/well)",
       title = "Environmental Biofilm",
       caption = "only adherent Bd visualized here (the only data we have)") +
  scale_color_manual(values = c("1%TB+AEbiofilm"= "orange",
                                "MQ+AEbiofilm" = "blue",
                                "PW+AEBiofilm" = "magenta",
                                "Added Bd" = "darkgrey")) + # Assign specific colors to match RC's plot
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(), # Remove major vertical grid lines
    panel.grid.minor.x = element_blank()) + # Remove minor vertical grid lines
  scale_x_continuous(breaks = c(0, 1, 3, 5, 7))
```

### Caitlin's version AE

```{r}
ae_summary <- ae %>%
  group_by(day, sample_ID) %>%
  reframe(mean = mean(adh), # calculate the mean
            n = length(adh), # count the number of observations
            df = n - 1, # calculate the degrees of freedom
            sd = sd(adh), # calculate the standard deviation
            se = sd/sqrt(n), # calculate the standard error
          ) %>%
  # add column for TB or no
  mutate(TB = case_when(str_detect(sample_ID, "TB") ~ "y", TRUE ~ "n")) %>%
  # add column for PW or no
  mutate(PW = case_when(str_detect(sample_ID, "PW") ~ "y", TRUE ~ "n"))

ae_summary %>%
  # reorder to match Renwei's plot
  mutate(sample_ID = factor(sample_ID,
                            levels = c("1%TB+AEbiofilm", "MQ+AEbiofilm",
                                       "PW+AEBiofilm",   "Added Bd"  ))) %>%

  ggplot(aes(x = day,
           y = mean,
           color = sample_ID)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - se, # plot the standard error
                    ymax = mean + se),
                width = 0.1) +
  geom_line() + 
  scale_y_log10(limits = c(1e3, 1e7),
                breaks = c(1e3, 1e4, 1e5, 1e6, 1e7)) +
  # vibes
  labs(x = "Day",
       y = "Bd Quantity per sample (ZE/well)",
       title = "Environmental Biofilm",
       caption = "only adherent Bd visualized here (the only data we have)") +
  scale_color_manual(values = c("1%TB+AEbiofilm"= "#4477AA",
                                "MQ+AEbiofilm" = "#228833",
                                "PW+AEBiofilm" = "#AA3377",
                                "Added Bd" = "darkgrey")) + 
  
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(), # Remove major vertical grid lines
    panel.grid.minor.x = element_blank()) + # Remove minor vertical grid lines
  scale_x_continuous(breaks = c(0, 1, 3, 5, 7))
```

## 3b EDA

### visualize y var: bd load

```{r}
# untransformed
ae_noday0 <- ae %>% 
  filter(day != 0) %>% 
  mutate(log_adh = log(adh)) # note: no zeroes so not log + 1
ggqqplot(ae_noday0, "adh", title = "untransformed")
shapiro.test(ae_noday0$adh) # nope
hist(ae_noday0$adh) # note

# transformed
ggqqplot(ae_noday0, "log_adh", title = "log transformed") # gorgeous
hist(ae_noday0$log_adh) # better
shapiro.test(ae_noday0$log_adh) # p-value = 0.1699 def normal
```

## 3b Stats

y var: amount of Bd in adherent

x vars: day & medium (MQ, TB, PW)

Bd \~ day\*medium

Question: Does the amount of Bd in the aquatic environmental biofilm differ across the media tested and across the days?

Model: 2-way ANOVA

Answer: Yes, there is a significant effect of day, presence of microbes, presence of TB as well as the interactions between day and microbes, day and TB, and a third-order interaction of day, microbes, and TB (three-way ANOVA, I recommend using a results table, it's a lot of p and f and df values to list)

```{r}
# quick check: we want day as a FACTOR
ae_noday0 <- ae_noday0 %>% 
  mutate(day = as.factor(day)) %>% 
# column for medium
mutate(medium = sample_ID)
str(ae_noday0$day)


# set MQ as reference
ae_noday0$sample_ID <- factor(ae_noday0$sample_ID)
ae_noday0$sample_ID <- relevel(ae_noday0$sample_ID, ref = "MQ+AEbiofilm")
```

## null

```{r}
null <- lm(log_adh ~ 1,
  data = ae_noday0)
AIC(null) #146.5865

```

## Bd \~ day\*medium

```{r}
# build model
mod1 <- aov(log_adh ~ day*medium,
  data = ae_noday0)

# diagnostic plot
par(mfrow = c(2,2))
plot(mod1) # kinda not homoskedastic

# look at results
summary(mod1)
anova(mod1) # all significant and interaction sig
AIC(mod1) # 37.78083 better than null

TukeyHSD(mod1) # all days sig diff from each other, all media sig diff from each other, second order is a bit messy
```

Summary of results

Day 1 > Day 3 > Day 5 > Day 7 (all p <0.005) in other words, Bd significantly reduced each day

MQ+AEbiofilm > PW+AEBiofilm > 1%TB+AEbiofilm (TB plus biofilm has most Bd inhibition power, followed by pond water, then by milliQ with the least inhibition power)

lets try Bd \~ day\*TB*PW

This is nearly identical, same AIC, I think needlessly complex

```{r}
# # build model
# mod2 <- aov(log_adh ~ day*TB*PW,
#   data = ae_noday0)
# 
# # diagnostic plot
# par(mfrow = c(2,2))
# plot(mod2) # kinda not homoskedastic
# 
# # look at results
# summary(mod2)
# anova(mod2) # all significant and interaction sig
# AIC(mod2) # 37.78083 same exact aic
# 
# TukeyHSD(mod2) # all days sig diff from each other, all media sig diff from each other, second order is a bit messy
``` 

# 4b Monolayer biofilm on Bd growth:

It looks like solid lines are with microbes and dashed lines are without microbes

### Renwei's figure

![](data/4b_monolayer.jpg){width="4in"}

### ggplot version: replicating Renwei's ML

```{r}
monolayer_summary <- monolayer %>% 
  group_by(day, sample_ID) %>% 
  reframe(mean = mean(adh_plus_sup), # calculate the mean
            n = length(adh_plus_sup), # count the number of observations
            df = n - 1, # calculate the degrees of freedom
            sd = sd(adh_plus_sup), # calculate the standard deviation
            se = sd/sqrt(n), # calculate the standard error
          ) %>% 
  mutate(microbes = case_when(
    str_detect(sample_ID, "\\+microbes") ~ "y",TRUE ~ "n")) %>% 
  # add column for TB or no
  mutate(TB = case_when(str_detect(sample_ID, "TB") ~ "y", TRUE ~ "n")) %>% 
  # add column for PW or no
  mutate(PW = case_when(str_detect(sample_ID, "PW") ~ "y", TRUE ~ "n")) 

monolayer_summary %>% 
  # reorder to match Renwei's plot
  mutate(sample_ID = factor(sample_ID, 
                            levels = c("TB+PW+microbes","PW+microbes",
                                        "TB+PW-microbes", "PW-microbes"))) %>% 
  ggplot(aes(x = day, 
           y = mean, 
           color = sample_ID)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - se, # plot the standard error
                    ymax = mean + se),
                width = 0.1) +
    geom_line(aes(linetype = microbes)) + 
  scale_y_log10(limits = c(1e4, 1e8), 
                breaks = c(1e4, 1e5, 1e6, 1e7, 1e8)) +
  # vibes
  labs(x = "Day",
       y = "Bd Quantity per sample (ZE/well)",
       title = "Monolayer",
       caption = "supernatant plus adherent visualized here") +
  scale_color_manual(values = c("TB+PW+microbes" = "palegreen4", 
                                "PW+microbes" = "magenta", 
                                "TB+PW-microbes" = "chocolate4", 
                                "PW-microbes" = "purple")) + # Assign specific colors to match RC's plot
  scale_linetype_manual(values = c("n" = "dashed", 
                                   "y" = "solid")) +
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(), # Remove major vertical grid lines
    panel.grid.minor.x = element_blank()) + # Remove minor vertical grid lines
  scale_x_continuous(breaks = c(0, 1, 3, 5, 7))
```

## Caitlin's version ML

```{r}
monolayer_summary <- monolayer %>% 
  group_by(day, sample_ID) %>% 
  reframe(mean = mean(adh_plus_sup), # calculate the mean
            n = length(adh_plus_sup), # count the number of observations
            df = n - 1, # calculate the degrees of freedom
            sd = sd(adh_plus_sup), # calculate the standard deviation
            se = sd/sqrt(n), # calculate the standard error
          ) %>% 
  mutate(microbes = case_when(
    str_detect(sample_ID, "\\+microbes") ~ "y",TRUE ~ "n")) %>% 
  # add column for TB or no
  mutate(TB = case_when(str_detect(sample_ID, "TB") ~ "y", TRUE ~ "n")) %>% 
  # add column for PW or no
  mutate(PW = case_when(str_detect(sample_ID, "PW") ~ "y", TRUE ~ "n")) 

monolayer_summary %>% 
  # reorder to match Renwei's plot
  mutate(sample_ID = factor(sample_ID, 
                            levels = c("TB+PW+microbes","PW+microbes",
                                        "TB+PW-microbes", "PW-microbes"))) %>% 
  ggplot(aes(x = day, 
           y = mean, 
           color = sample_ID)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - se, # plot the standard error
                    ymax = mean + se),
                width = 0.1) +
    geom_line(aes(linetype = microbes)) + 
  scale_y_log10(limits = c(1e4, 1e8), 
                breaks = c(1e4, 1e5, 1e6, 1e7, 1e8)) +
  
  # vibes
  labs(x = "Day",
       y = "Bd Quantity per sample (ZE/well)",
       title = "Monolayer Bd: colorblind friendly",
       caption = "supernatant plus adherent visualized here") +
  scale_color_manual(values = c("TB+PW+microbes" = "#4477AA", 
                                "PW+microbes" = "#EE6677", 
                                "TB+PW-microbes" = "#66CCEE", 
                                "PW-microbes" = "#AA3377")) + # Assign specific colors to match RC's plot
  scale_linetype_manual(values = c("n" = "dashed", 
                                   "y" = "solid")) +
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(), # Remove major vertical grid lines
    panel.grid.minor.x = element_blank()) + # Remove minor vertical grid lines
  scale_x_continuous(breaks = c(0, 1, 3, 5, 7))
```
# 4b EDA

### visualize y var: bd load

```{r}
# untransformed
ml_noday0 <- monolayer %>% 
  filter(day != 0) %>% 
  mutate(log_adh_plus_sup = log(adh_plus_sup)) # note: no zeroes so not log + 1
ggqqplot(ml_noday0, "adh_plus_sup", title = "untransformed")
shapiro.test(ml_noday0$adh_plus_sup) # nope
hist(ml_noday0$adh_plus_sup) # note

# transformed
ggqqplot(ml_noday0, "log_adh_plus_sup", title = "log transformed") # gorgeous
hist(ml_noday0$log_adh_plus_sup) # better
shapiro.test(ml_noday0$log_adh_plus_sup) # p-value = 0.01321 not quite normal
```

## 4b Stats

y var: amount of Bd

x vars: day, treatment, microbes y/n, pw y/n, tb y/n

Best model: Bd \~ day\*microbes\*TB

Question: Does the amount of Bd in the sample differ across the treatments of presence of microbes, TB, and day?

Model: 3-way ANOVA

```{r}
# quick check: we want day as a FACTOR
ml_noday0 <- ml_noday0 %>% 
  mutate(day = as.factor(day))
str(ml_noday0$day)

# set PW-microbes as reference (no milliQ here)
ml_noday0$sample_ID <- factor(ml_noday0$sample_ID)
ml_noday0$sample_ID <- relevel(ml_noday0$sample_ID, ref = "PW-microbes")
```

## null

```{r}
null <- lm(log_adh_plus_sup ~ 1,
  data = ml_noday0)
AIC(null) #205.8778

```

## Best model: Bd \~ day\*microbes\*TB

```{r}
# build model
mod3 <- aov(log_adh_plus_sup ~ day*microbes*TB,
  data = ml_noday0)

# diagnostic plot
par(mfrow = c(2,2))
plot(mod3) # not bad

# look at results
summary(mod3)
anova(mod3) # day, microbes, tb are all significant, interactions: day:TB, day:microbes, day:microbes:TB, NOT microbes:TB 
AIC(mod3) # 123.1704 better than null

TukeyHSD(mod3)

```


