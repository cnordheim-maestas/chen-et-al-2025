---
title: "NCOS biofilm"
author: "Caitlin Nordheim-Maestas"
format:
  html:
    toc: true
    code-fold: true
    toc-location: left
---

# Goal: Re-create Renwei's visualizations in R and run stats across treatments and time

See Renwei's excel version here: <https://drive.google.com/file/d/1Dy_jAW0lTQZohf7V-l5VxQ_LrNLP9Aai/view?usp=sharing>

```{r}
#| warning: false

## read in and clean data
library(tidyverse) # for cleaning and viewing data
library(here) # for importing data
library(ggpubr)
library(rstatix)
library(ggplot2)
library(car)
library(multcomp)
library(nlme)
library(emmeans)

fig_2b <- read.csv(here("data", "final_NCOS_2024_reformatted_for_R.xlsx - Fig2B.csv"))
fig_3b <- read.csv(here("data", "final_NCOS_2024_reformatted_for_R.xlsx - Fig3B.csv"))
fig_4b <- read.csv(here("data", "final_NCOS_2024_reformatted_for_R.xlsx - Fig4B.csv"))

with_microbes_40_color <- "#999933"
no_microbes_.22_color <- "#88ccee"
```

# Data reformatting and cleaning

```{r}
# add column for microbes or no
fig_2b <- fig_2b %>% 
  mutate(microbes = case_when(
    str_detect(sample_ID, "\\+microorganism") ~ "y",
    TRUE ~ "n"
  )) %>% 
  # add column for TB or no
  mutate(TB = case_when(
    str_detect(sample_ID, "TB") ~ "y",
    TRUE ~ "n"
  )) %>% 
  # add column for PW or no
  mutate(PW = case_when(
    str_detect(sample_ID, "PW") ~ "y",
    TRUE ~ "n"
  ))
```

# Fig 2b

I am not sure what the experimental set up is, but here is a re-creation of Renwei's excel figure.

It looks like solid lines are with microbes and dashed lines are without microbes

## Over time

### Renwei's figure

![](data/fig_2b_Renweiexcelversion.jpg){fig-align="left" width="4in"}

### ggplot version: replicating Renwei's

```{r}
fig2b_summary <- fig_2b %>% 
  group_by(day, sample_ID) %>% 
  reframe(mean = mean(adh_plus_sup), # calculate the mean
            n = length(adh_plus_sup), # count the number of observations
            df = n - 1, # calculate the degrees of freedom
            sd = sd(adh_plus_sup), # calculate the standard deviation
            se = sd/sqrt(n), # calculate the standard error
          ) %>% 
  mutate(microbes = case_when(
    str_detect(sample_ID, "\\+microorganism") ~ "y",TRUE ~ "n")) %>% 
  # add column for TB or no
  mutate(TB = case_when(str_detect(sample_ID, "TB") ~ "y", TRUE ~ "n")) %>% 
  # add column for PW or no
  mutate(PW = case_when(str_detect(sample_ID, "PW") ~ "y", TRUE ~ "n")) 

fig2b_summary %>% 
  # reorder to match Renwei's plot
  mutate(sample_ID = factor(sample_ID, 
                            levels = c("1%TB", "MQ", "1%TB+PW+microorganism", "PW+microorganism", "1%TB+PW-microorganism", "PW-microorganism", "Added Bd"))) %>% 

  ggplot(aes(x = day, 
           y = mean, 
           color = sample_ID)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - se, # plot the standard error
                    ymax = mean + se),
                width = 0.1) +
    geom_line(aes(linetype = microbes)) + 
  scale_y_log10(limits = c(1e3, 1e8), 
                breaks = c(1e3, 1e4, 1e5, 1e6, 1e7, 1e8)) +
  # vibes
  labs(x = "Day",
       y = "Bd Quantity per sample (ZE/well)",
       title = "NCOS data from tab called fig 2b",
       caption = "supernatant plus adherent visualized here") +
  scale_color_manual(values = c("1%TB" = "goldenrod", 
                                "MQ" = "blue", 
                                "1%TB+PW+microorganism" = "darkolivegreen3", 
                                "PW+microorganism" = "magenta", 
                                "1%TB+PW-microorganism" = "palegreen4", 
                                "PW-microorganism" = "palevioletred1",
                                "Added Bd" = "darkgrey")) + # Assign specific colors to match RC's plot
  scale_linetype_manual(values = c("n" = "dashed", 
                                   "y" = "solid")) +
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(), # Remove major vertical grid lines
    panel.grid.minor.x = element_blank()) + # Remove minor vertical grid lines
  scale_x_continuous(breaks = c(0, 1, 3, 5, 7))
```

## Caitlin's version

Used colorblind friendly palette

```{r}
fig2b_summary <- fig_2b %>% 
  group_by(day, sample_ID) %>% 
  reframe(mean = mean(adh_plus_sup), # calculate the mean
            n = length(adh_plus_sup), # count the number of observations
            df = n - 1, # calculate the degrees of freedom
            sd = sd(adh_plus_sup), # calculate the standard deviation
            se = sd/sqrt(n), # calculate the standard error
          ) %>% 
  mutate(microbes = case_when(
    str_detect(sample_ID, "\\+microorganism") ~ "y",TRUE ~ "n")) %>% 
  # add column for TB or no
  mutate(TB = case_when(str_detect(sample_ID, "TB") ~ "y", TRUE ~ "n")) %>% 
  # add column for PW or no
  mutate(PW = case_when(str_detect(sample_ID, "PW") ~ "y", TRUE ~ "n")) 

fig2b_summary %>% 
  # reorder to match Renwei's plot
  mutate(sample_ID = factor(sample_ID, 
                            levels = c("1%TB", "MQ", "1%TB+PW+microorganism", "PW+microorganism", "1%TB+PW-microorganism", "PW-microorganism", "Added Bd"))) %>% 

  ggplot(aes(x = day, 
           y = mean, 
           color = sample_ID)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - se, # plot the standard error
                    ymax = mean + se),
                width = 0.1) +
    geom_line(aes(linetype = microbes)) + 
  scale_y_log10(limits = c(1e3, 1e8), 
                breaks = c(1e3, 1e4, 1e5, 1e6, 1e7, 1e8)) +
  # vibes
  labs(x = "Day",
       y = "Bd Quantity per sample (ZE/well)",
       title = "NCOS data from tab called fig 2b: Colorblind friendly colors",
       caption = "supernatant plus adherent visualized here") +
  scale_color_manual(values = c("1%TB" = "#CCBB44", 
                                "MQ" = "#228833", 
                                "1%TB+PW+microorganism" = "#4477AA", 
                                "PW+microorganism" = "#EE6677", 
                                "1%TB+PW-microorganism" = "#66CCEE", 
                                "PW-microorganism" = "#AA3377",
                                "Added Bd" = "#BBBBBB")) + # Assign specific colors to match RC's plot
  scale_linetype_manual(values = c("n" = "dashed", 
                                   "y" = "solid")) +
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(), # Remove major vertical grid lines
    panel.grid.minor.x = element_blank()) + # Remove minor vertical grid lines
  scale_x_continuous(breaks = c(0, 1, 3, 5, 7))
```

# EDA

## boxplot match East Bay experiment, let's remove TB for now

Interesting, in NCOS, by day 1, there was alreadya decline in the amount of Bd in the microbes treatment, unlike in the Bay, where the decline took more time

```{r}
fig_2b %>% 
  filter(day != 0 ) %>%
  filter(TB != "y") %>% # remove all treatments with TB broth
 # filter(day != 3 & day != 5) %>% 
  
  ggplot(aes(y= adh_plus_sup, x = sample_ID, fill = sample_ID)) + 
    geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.3) +
  scale_y_log10() + 
   facet_wrap(~day, nrow = 1, labeller = labeller(day = c("1" = "Day 1", "3" = "Day 3", 
                                                          "5" = "Day 5", "7" = "Day 7"))) +
    scale_fill_manual(values = c("PW+microorganism" = with_microbes_40_color, 
                                "PW-microorganism" = no_microbes_.22_color,
                                
                                "MQ" = "darkgrey")) +
  scale_x_discrete (labels= c("PW+microorganism" = "Present", "PW-microorganism" = "Absent", "MQ" = "Control")) +
  labs(x = "Presence of microbes in pond water",
       y = "Bd Quantity per sample (ZE/well)",
       title = "NCOS data from tab called fig 2b",
       caption = "supernatant plus adherent visualized here") +
  theme_classic() +
   theme(legend.position = "none",
         strip.text = element_text(face="bold"),
         axis.title = element_text(face = "bold"))
```

This will allow for the p-values differentiating days and microbe presence absence if that is wanted

### visualize y var: bd load

```{r}
# untransformed
fig_2b_noday0 <- fig_2b %>% 
  filter(day != 0) %>% 
  mutate(log_adh_plus_sup = log(adh_plus_sup)) # note: no zeroes so not log + 1
ggqqplot(fig_2b_noday0, "adh_plus_sup", title = "untransformed")
shapiro.test(fig_2b_noday0$adh_plus_sup) # nope
hist(fig_2b_noday0$adh_plus_sup) # note

# transformed
ggqqplot(fig_2b_noday0, "log_adh_plus_sup", title = "log transformed") # gorgeous
hist(fig_2b_noday0$log_adh_plus_sup) # better
shapiro.test(fig_2b_noday0$log_adh_plus_sup) # p-value = 0.01361, does not pass shapiro, but this has an n of 72 which is more than the recommended <50 samples

```

# Stats

y var: amount of Bd

x vars: day, treatment, microbes y/n, pw y/n, tb y/n

Best model: Bd ~ day\*microbes\*TB

Question: Does the amount of Bd in the sample differ across the treatments of presence of microbes, TB, and day?

Model: 3-way ANOVA

Answer: Yes, there is a significant effect of day, presence of microbes, presence of TB as well as the interactions between day and microbes, day and TB, and a third-order interaction of day, microbes, and TB (three-way ANOVA, I recommend using a results table, it's a lot of p and f and df values to list)

First-order comparisons:

Samples with: 
the presence of microbes are associated with lower Bd
with TB have higher Bd
days 1-7 and 3-7 are different, with day 1 having higher Bd than day 3 and day 3 having higher bd than day 7

I dont recommend writing out all second-order and third-order comparisons, but you can say something like there is an influence of the interaction of microbes and the day, and TB and the day. 

```{r}
# quick check: we want day as a FACTOR
fig_2b_noday0 <- fig_2b_noday0 %>% 
  mutate(day = as.factor(day))
str(fig_2b_noday0$day)

# set MQ as reference
fig_2b_noday0$sample_ID <- factor(fig_2b_noday0$sample_ID)
fig_2b_noday0$sample_ID <- relevel(fig_2b_noday0$sample_ID, ref = "MQ")
```


## null

```{r}
null <- lm(log_adh_plus_sup ~ 1,
  data = fig_2b_noday0)
AIC(null) #326.4356

```

## Best model: Bd ~ day\*microbes\*TB

Q: is it more appropriate to also do random effect of treatment? We can try it

```{r}
# build model
mod3 <- aov(log_adh_plus_sup ~ day*microbes*TB,
  data = fig_2b_noday0)

# diagnostic plot
par(mfrow = c(2,2))
plot(mod3) # looks good

# look at results
summary(mod3)
anova(mod3) # day, microbes, tb are all significant, interactions: day:TB, day:microbes, day:microbes:TB, NOT microbes:TB 
AIC(mod3) # 161.4887 BEST MODEL

TukeyHSD(mod3)

# comparisons
em <- emmeans(mod3, ~ day * microbes * TB)
# Perform the Tukey test for pairwise comparisons
tukey_results <- contrast(em, method = "tukey")
# View the results
summary(tukey_results)

```

## Bd ~ day + treatment

If it is important to you to have p-values comparing at the treatment level, you can use this instead, but I think it provides less information than the model above, and it has a higher aic value

Significant Contrasts (p-value < 0.05):

1. **MQ - (1%TB+PW+microorganism)**: p-value = `<.0001`
2. **MQ - (PW+microorganism)**: p-value = `<.0001`
3. **1%TB - (1%TB+PW+microorganism)**: p-value = `<.0001`
4. **1%TB - (PW+microorganism)**: p-value = `<.0001`
5. **(1%TB+PW-microorganism) - (1%TB+PW+microorganism)**: p-value = `<.0001`
6. **(1%TB+PW-microorganism) - (PW+microorganism)**: p-value = `<.0001`
7. **(1%TB+PW+microorganism) - (PW-microorganism)**: p-value = `<.0001`
8. **(PW-microorganism) - (PW+microorganism)**: p-value = `<.0001`

Non-Significant Contrasts (p-value ≥ 0.05):

1. **MQ - 1%TB**: p-value = `0.3017`
2. **MQ - (1%TB+PW-microorganism)**: p-value = `0.0500` (marginal significance)
3. **MQ - (PW-microorganism)**: p-value = `0.9917`
4. **1%TB - (1%TB+PW-microorganism)**: p-value = `0.9586`
5. **1%TB - (PW-microorganism)**: p-value = `0.6577`
6. **(1%TB+PW-microorganism) - (PW-microorganism)**: p-value = `0.1888`
7. **(1%TB+PW+microorganism) - (PW-microorganism)**: p-value = `0.1940`

```{r}
# build model
mod <- lm(log_adh_plus_sup ~ day + sample_ID,
  data = fig_2b_noday0)

# diagnostic plot
par(mfrow = c(2,2))
plot(mod)

# look at results
summary(mod)
anova(mod) # day is significant, sample id is too
AIC(mod) # 237.1393

# comparisons by day
emmeans::emmeans(mod, pairwise ~ day) # pairwise comparisons

# comparisons by treatment
emmeans::emmeans(mod, pairwise ~ sample_ID) # pairwise comparisons
```

## No interactions: Bd ~ day + microbes + PW + TB

This is nt a great model, but I kept it for yall to see

```{r}
# build model
mod2 <- lm(log_adh_plus_sup ~ day + microbes + PW + TB,
  data = fig_2b_noday0)

# diagnostic plot
par(mfrow = c(2,2))
plot(mod2) # looks better tbh

# look at results
summary(mod2)
anova(mod2) # day, microbes, tb are all significant
AIC(mod2) # 233.1865 better model!

# comparisons
emmeans::emmeans(mod2, pairwise ~ day) # same pattern as previous model, day 1-7 and 3-7
emmeans::emmeans(mod2, pairwise ~ microbes) # microbes p <.0001, no microbes sig more
emmeans::emmeans(mod2, pairwise ~ TB) # TB p = 0.0002, with TB is sig more

```
